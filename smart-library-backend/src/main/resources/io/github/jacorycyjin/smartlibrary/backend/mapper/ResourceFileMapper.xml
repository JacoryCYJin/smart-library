<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="io.github.jacorycyjin.smartlibrary.backend.mapper.ResourceFileMapper">

    <resultMap id="BaseResultMap" type="io.github.jacorycyjin.smartlibrary.backend.entity.ResourceFile">
        <id column="id" property="id"/>
        <result column="resource_id" property="resourceId"/>
        <result column="file_type" property="fileType"/>
        <result column="file_url" property="fileUrl"/>
        <result column="file_size" property="fileSize"/>
        <result column="ctime" property="ctime"/>
        <result column="deleted" property="deleted"/>
    </resultMap>

    <sql id="Base_Column_List">
        id, resource_id, file_type, file_url, file_size, ctime, deleted
    </sql>

    <!-- 插入单个文件 -->
    <insert id="insert" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO resource_file (
        resource_id, file_type, file_url, file_size, ctime, deleted
        ) VALUES (
        #{resourceId}, #{fileType}, #{fileUrl}, #{fileSize}, NOW(), 0
        )
    </insert>

    <!-- 批量插入文件 -->
    <insert id="batchInsert" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO resource_file (
        resource_id, file_type, file_url, file_size, ctime, deleted
        ) VALUES
        <foreach collection="list" item="item" separator=",">
            (#{item.resourceId}, #{item.fileType}, #{item.fileUrl}, #{item.fileSize}, NOW(), 0)
        </foreach>
    </insert>

    <!-- 根据资源ID查询文件列表 -->
    <select id="selectByResourceId" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM resource_file
        WHERE resource_id = #{resourceId}
        AND deleted = 0
    </select>

    <!-- 根据资源ID逻辑删除所有文件 -->
    <update id="deleteByResourceId">
        UPDATE resource_file
        SET deleted = 1
        WHERE resource_id = #{resourceId}
    </update>

</mapper>
